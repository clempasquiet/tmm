--
-- Copyright (c) 2016, F5 Networks, Inc. All rights reserved.
-- No part of this software may be reproduced or transmitted in any
-- form or by any means, electronic or mechanical, for any purpose,
-- without express written permission of F5 Networks, Inc.
--
-- QAT crypto tmrate configuration file.
--

tables = {
    --
    -- QAT device ring table.
    --
    ["tmm/qat_dev_ring"] = {
        --
        -- msgs_delta
        --
        -- Hidden stat for the number of messages in the last second.
        --
        ["msgs_delta_attr"] = {
            func = function(row) return row["msgs"] end,
            delta = { 1, ref="msgs_delta", hidden=true },
        },


        --
        -- bytes_delta
        --
        -- Hidden stat for the number of bytes in the last second.
        --
        ["bytes_delta_attr"] = {
            func = function(row) return row["bytes"] end,
            delta = { 1, ref="bytes_delta", hidden=true },
        },


        --
        -- frags_delta
        --
        -- Hidden stat for the number of fragments in the last second.
        --
        ["frags_delta_attr"] = {
            func = function(row) return row["frags"] end,
            delta = { 1, ref="frags_delta", hidden=true },
        },


        --
        -- Average number of bytes per message.
        --
        ["avg_bytes_per_msg"] = {
            func = function(row)
                if row["msgs_delta"] > 0 then
                    return math.floor(
                            row["bytes_delta"] / row["msgs_delta"]);
                else
                    return 0;
                end
            end,
            sample = { 1, name="avg bytes/msg" },
        },


        --
        -- Average fragment size.
        --
        ["avg_frag_size"] = {
            func = function(row)
                if row["frags_delta"] > 0 then
                    return math.floor(
                            row["bytes_delta"] / row["frags_delta"]);
                else
                    return 0;
                end
            end,
            sample = { 1, name="avg frag size" },
        },


        --
        -- Average number of fragments per message.
        --
        ["avg_frags_per_msg"] = {
            func = function(row)
                if row["msgs_delta"] > 0 then
                    return row["frags_delta"] / row["msgs_delta"];
                else
                    return 0;
                end
            end,
            sample = { 1, name="avg frags/msg" },
        },


        --
        -- Only process rows with non-zero fragments.
        --
        filter = function(row)
            return row["frags"] > 0;
        end,
    },
}


